version: 2.1

orbs:
  docker: circleci/docker@2.2.0

jobs:
  build:
    docker:
        - image: ypereirareis/docker-compose
    steps:
        - docker/install-docker-compose
        - checkout
        - setup_remote_docker
        - run:
            name: Set .env file
            command: cp .env_example .env
        - run:
            name: Set variables in .env file
            command: sed -i 's/^TIMEZONE=/TIMEZONE=Etc\/UTC/g' .env && sed -i 's/^VIDEO_PATH=/VIDEO_PATH=.\/video/g' .env && sed -i 's/^SYNCTHING_PATH=/SYNCTHING_PATH=.\/syncthing/g' .env
        - run:
            name: Remove device lines out of jellyfin configuration
            command: sed -i 's/devices://g;s/- \/dev\/dri:\/dev\/dri//g' docker-compose.yaml
        - run:
            name: Create required directories
            command: mkdir -p ./proxy/certs && echo "user  nginx;" > ./proxy/nginx.conf
        - run:
            name: List contents
            command: find .
        - run:
            name: Pull all containers
            command: docker-compose pull -q
        - run:
            name: Launch some containers
            command: docker-compose up -d vpn rutorrent autoheal cgp ddclient mariadb postfix proxy

