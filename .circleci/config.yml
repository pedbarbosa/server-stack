version: 2.1

orbs:
  docker: circleci/docker@2.2.0

jobs:
  build:
    docker:
        - image: ypereirareis/docker-compose
    steps:
        - docker/install-docker-compose
        - checkout
        - setup_remote_docker
        - run:
            name: Set .env file
            command: cp .env_example .env
        - run:
            name: Set variables in .env file
            command: sed -i 's/^TIMEZONE=/TIMEZONE=Etc\/UTC/g' .env && sed -i 's/^VIDEO_PATH=/VIDEO_PATH=.\/video/g' .env && sed -i 's/^SYNCTHING_PATH=/SYNCTHING_PATH=.\/syncthing/g' .env
        - run:
            name: Create required directories
            command: mkdir -p ./proxy/certs && touch ./proxy/nginx.conf
        - run:
            name: Test
            command: docker ps -a; docker-compose pull -q; docker ps -a; docker-compose up cgp; docker ps -a

